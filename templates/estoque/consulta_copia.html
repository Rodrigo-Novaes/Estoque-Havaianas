{% extends "layout/base.html" %}

{% block title %}Consulta de Estoque - Sistema Havaianas{% endblock %}

{% block page_title %}
<i class="bi bi-search me-2"></i>Consulta de Estoque
{% endblock %}

{% block page_actions %}
<a href="{{ url_for('entrada_estoque') }}" class="btn btn-primary">
    <i class="bi bi-arrow-down-circle me-1"></i> Nova Entrada
</a>
<a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i> Voltar
</a>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-0">Todos os Produtos em Estoque</h5>
                    </div>
                    <div class="col-md-6">
                        <!-- BUSCA INTELIGENTE -->
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" 
                                   class="form-control" 
                                   id="buscaEstoque" 
                                   placeholder="Digite produto, cor, tamanho ou SKU..."
                                   value="{{ busca or '' }}"
                                   aria-label="Buscar estoque">
                            <button class="btn btn-outline-secondary" type="button" onclick="limparBusca()" title="Limpar busca" style="display: none;" id="limpar-busca">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <small class="text-muted mt-1 d-block">
                            <i class="bi bi-info-circle"></i> Scanner automático ativo • Digite ou use leitor de código
                        </small>
                        
                        <!-- Formulário original escondido -->
                        <form method="GET" id="formBuscaOriginal" style="display: none;">
                            <input type="text" name="q" id="inputBuscaOriginal" value="{{ busca or '' }}">
                            <button type="submit" id="submitBuscaOriginal" style="display: none;">Buscar</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="tabelaEstoque">
                        <thead class="table-light">
                            <tr>
                                <th width="80px">Imagem</th>
                                <th>Produto</th>
                                <th>Cor</th>
                                <th>Tamanho</th>
                                <th>Estoque Atual</th>
                                <th>Mínimo</th>
                                <th>Localização</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaEstoque">
                            {% for grade in grades %}
                            <tr data-descricao="{{ grade.produto.descricao|lower }}"
                                data-cor="{{ grade.cor|lower }}"
                                data-tamanho="{{ grade.tamanho|lower }}"
                                data-sku="{{ grade.sku_grade|lower }}"
                                data-localizacao="{{ grade.localizacao|lower }}"
                                data-produto-id="{{ grade.produto.id }}">
                                <td style="text-align: center; vertical-align: middle; padding-left: 15px; padding-right: 15px;">
                                    <!-- PLACEHOLDER INLINE SEM REQUISIÇÕES -->
                                    <div class="imagem-container" data-produto-id="{{ grade.produto.id }}" style="cursor: pointer;" onclick="ampliarImagem(this)">
                                        <svg width="50" height="50" viewBox="0 0 50 50" class="img-thumbnail placeholder-imagem">
                                            <rect width="50" height="50" fill="#f8f9fa" stroke="#dee2e6" stroke-width="1"/>
                                            <text x="10" y="25" font-family="Arial" font-size="10" fill="#adb5bd">Sem</text>
                                            <text x="10" y="35" font-family="Arial" font-size="10" fill="#adb5bd">Imagem</text>
                                        </svg>
                                    </div>
                                </td>
                                <td>
                                    <strong>{{ grade.produto.descricao[:30] }}</strong><br>
                                    <small class="text-muted">{{ grade.sku_grade }}</small>
                                </td>
                                <td>{{ grade.cor }}</td>
                                <td><span class="badge bg-dark">{{ grade.tamanho }}</span></td>
                                <td>
                                    {% set estoque_atual_num = grade.estoque_atual|int %}
                                    {% set estoque_minimo_num = grade.estoque_minimo|int %}
                                    <span class="badge {% if estoque_atual_num < estoque_minimo_num %}bg-danger{% elif estoque_atual_num > 0 %}bg-success{% else %}bg-secondary{% endif %}">
                                        {{ grade.estoque_atual }}
                                    </span>
                                </td>
                                <td>{{ grade.estoque_minimo }}</td>
                                <td>
                                    <small class="text-muted">{{ grade.localizacao }}</small>
                                </td>
                                <td>
                                    {% set estoque_atual_num = grade.estoque_atual|int %}
                                    {% set estoque_minimo_num = grade.estoque_minimo|int %}
                                    {% if estoque_atual_num < estoque_minimo_num and estoque_atual_num > 0 %}
                                    <span class="badge bg-warning">Estoque Baixo</span>
                                    {% elif estoque_atual_num == 0 %}
                                    <span class="badge bg-danger">Esgotado</span>
                                    {% else %}
                                    <span class="badge bg-success">Normal</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="8" class="text-center py-5">
                                    <i class="bi bi-inbox fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">Nenhum produto encontrado</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            {% if grades %}
            <div class="card-footer bg-white">
                <div class="row">
                    <div class="col-md-4">
                        <small class="text-muted d-block">Total de Grades</small>
                        <strong>{{ grades|length }}</strong>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted d-block">Total em Estoque</small>
                        <strong id="total-estoque">
                            {{ grades|sum(attribute='estoque_atual') }}
                        </strong>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted d-block">Estoque Baixo</small>
                        <strong class="text-warning">
                            {{ estoque_baixo if estoque_baixo is defined else 0 }}
                        </strong>                   
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal para ampliar imagem -->
<div class="modal fade" id="modalImagem" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center p-3">
                <img src="" class="img-fluid" id="imagemAmpliada" style="max-height: 300px;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Adicionar DataTables CSS e JS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<script type="text/javascript" src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<style>
/* Estilos otimizados */
.imagem-container {
    display: inline-block;
    width: 50px;
    height: 50px;
    overflow: hidden;
}

.placeholder-imagem {
    transition: transform 0.2s;
}

.placeholder-imagem:hover {
    transform: scale(1.5);
    z-index: 10;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
}

#tabelaEstoque td:nth-child(1) {
    text-align: center;
    vertical-align: middle;
    width: 80px;
    padding-left: 15px !important;
    padding-right: 15px !important;
}

#tabelaEstoque th:nth-child(1) {
    width: 80px;
    text-align: center;
    padding-left: 15px !important;
    padding-right: 15px !important;
}

/* Estilo DataTable nativo */
.dataTables_wrapper .dataTables_length,
.dataTables_wrapper .dataTables_filter {
    margin-bottom: 1rem;
}
.dataTables_wrapper .dataTables_length select,
.dataTables_wrapper .dataTables_filter input {
    padding: 0.25rem 0.5rem;
    border-radius: 0.2rem;
    border: 1px solid #dee2e6;
}
.dataTables_wrapper .dataTables_filter input:focus {
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}
.dataTables_wrapper .dataTables_paginate .paginate_button {
    padding: 0.25rem 0.5rem;
    margin: 0 2px;
    border-radius: 0.2rem;
    border: 1px solid #dee2e6;
    color: #0d6efd;
    cursor: pointer;
}
.dataTables_wrapper .dataTables_paginate .paginate_button:hover {
    background-color: #e9ecef;
    border-color: #dee2e6;
}
.dataTables_wrapper .dataTables_paginate .paginate_button.current {
    background-color: #0d6efd;
    color: white !important;
    border-color: #0d6efd;
}
</style>

<script>
// VARIÁVEIS GLOBAIS
let todasGrades = [];
let ultimoCodigoLido = '';
let imagensCarregadas = new Set(); // Controlar quais já foram carregadas

// ========== FUNÇÕES PARA IMAGENS OTIMIZADAS ==========
function carregarImagensEstoque() {
    const containers = document.querySelectorAll('.imagem-container[data-produto-id]');
    let index = 0;
    
    function carregarProximaImagem() {
        if (index >= containers.length) return;
        
        const container = containers[index];
        const produtoId = container.getAttribute('data-produto-id');
        
        // Verificar se já foi carregada
        if (imagensCarregadas.has(produtoId)) {
            index++;
            carregarProximaImagem();
            return;
        }
        
        fetch(`/api/produto/imagem/${produtoId}`)
            .then(response => response.json())
            .then(data => {
                if (data.imagem) {
                    // Substituir SVG por imagem real
                    const img = document.createElement('img');
                    img.src = `/uploads/produtos/thumb_${data.imagem}`;
                    img.className = 'img-thumbnail';
                    img.style.width = '50px';
                    img.style.height = '50px';
                    img.style.objectFit = 'contain';
                    img.style.cursor = 'pointer';
                    img.onclick = function() { ampliarImagem(this); };
                    img.onerror = function() { 
                        // Se erro, manter placeholder
                        container.innerHTML = container.innerHTML;
                    };
                    
                    container.innerHTML = '';
                    container.appendChild(img);
                    imagensCarregadas.add(produtoId);
                }
                index++;
                
                // Pequeno delay entre requisições
                setTimeout(carregarProximaImagem, 200);
            })
            .catch(err => {
                console.log('Erro ao carregar imagem:', err);
                index++;
                setTimeout(carregarProximaImagem, 200);
            });
    }
    
    // Começar carregamento em lotes
    carregarProximaImagem();
}

function ampliarImagem(elemento) {
    const modalImg = document.getElementById('imagemAmpliada');
    
    if (elemento.tagName === 'IMG') {
        modalImg.src = elemento.src;
    } else {
        // Se for container com SVG, tentar encontrar imagem ou usar placeholder
        const img = elemento.querySelector('img');
        if (img) {
            modalImg.src = img.src;
        } else {
            modalImg.src = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'300\' viewBox=\'0 0 300 300\'%3E%3Crect width=\'300\' height=\'300\' fill=\'%23f8f9fa\'/%3E%3Ctext x=\'100\' y=\'150\' font-family=\'Arial\' font-size=\'20\' fill=\'%23adb5bd\'%3ESem%3C/text%3E%3Ctext x=\'110\' y=\'180\' font-family=\'Arial\' font-size=\'20\' fill=\'%23adb5bd\'%3EImagem%3C/text%3E%3C/svg%3E';
        }
    }
    
    const modal = new bootstrap.Modal(document.getElementById('modalImagem'));
    modal.show();
}

// DOCUMENT READY
document.addEventListener('DOMContentLoaded', function() {
    // Coletar todas as grades
    const linhas = document.querySelectorAll('#corpoTabelaEstoque tr');
    todasGrades = Array.from(linhas);
    
    // Carregar imagens APENAS se houver poucas linhas, ou carregar sob demanda
    if (todasGrades.length <= 50) {
        // Carregar imagens gradualmente
        setTimeout(carregarImagensEstoque, 1000);
    } else {
        console.log('Muitas linhas, imagens carregadas sob demanda');
        // Opcional: carregar apenas quando o usuário rolar a página
    }
    
    // Inicializar DataTable
    $('#tabelaEstoque').DataTable({
        language: {
            url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json"
        },
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
        order: [[1, 'asc']],
        responsive: true,
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>tip',
        drawCallback: function() {
            $('.dataTables_paginate').addClass('btn-group-sm');
            atualizarContadoresEstoque();
        }
    });
    
    // Configurar campo de busca
    const campoBusca = document.getElementById('buscaEstoque');
    const btnLimpar = document.getElementById('limpar-busca');
    const inputBuscaOriginal = document.getElementById('inputBuscaOriginal');
    
    if (campoBusca) {
        campoBusca.focus();
        campoBusca.select();
        
        if (campoBusca.value.trim() !== '') {
            btnLimpar.style.display = 'block';
        }
    }
    
    function verificarBotaoLimpar() {
        if (campoBusca.value.trim() !== '') {
            btnLimpar.style.display = 'block';
        } else {
            btnLimpar.style.display = 'none';
        }
    }
    
    // Busca com debounce
    let timeoutBusca;
    campoBusca.addEventListener('input', function() {
        clearTimeout(timeoutBusca);
        timeoutBusca = setTimeout(() => {
            filtrarTabelaEstoque(this.value);
            
            if (inputBuscaOriginal) {
                inputBuscaOriginal.value = this.value;
            }
            
            verificarBotaoLimpar();
        }, 300);
        
        if (this.value.trim() !== '') {
            btnLimpar.style.display = 'block';
        } else {
            btnLimpar.style.display = 'none';
        }
    });
    
    // Scanner
    campoBusca.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const codigo = this.value.trim();
            if (codigo && codigo !== ultimoCodigoLido) {
                ultimoCodigoLido = codigo;
                filtrarTabelaEstoque(codigo);
                
                if (inputBuscaOriginal) {
                    inputBuscaOriginal.value = codigo;
                }
                
                verificarBotaoLimpar();
                
                setTimeout(() => {
                    this.value = '';
                    if (inputBuscaOriginal) {
                        inputBuscaOriginal.value = '';
                    }
                    btnLimpar.style.display = 'none';
                    this.focus();
                }, 100);
            }
        }
        
        if (e.key === 'F3') {
            e.preventDefault();
            this.focus();
            this.select();
        }
    });
    
    atualizarContadoresEstoque();
});

// FILTRAR TABELA
function filtrarTabelaEstoque(termoBusca) {
    const termo = termoBusca.toLowerCase().trim();
    
    todasGrades.forEach(linha => {
        if (termo === '') {
            linha.style.display = '';
        } else {
            const descricao = linha.getAttribute('data-descricao') || '';
            const cor = linha.getAttribute('data-cor') || '';
            const tamanho = linha.getAttribute('data-tamanho') || '';
            const sku = linha.getAttribute('data-sku') || '';
            const localizacao = linha.getAttribute('data-localizacao') || '';
            
            const encontrou = 
                descricao.includes(termo) ||
                cor.includes(termo) ||
                tamanho.includes(termo) ||
                sku.includes(termo) ||
                localizacao.includes(termo);
            
            linha.style.display = encontrou ? '' : 'none';
        }
    });
    
    atualizarContadoresEstoque();
}

// ATUALIZAR CONTADORES
function atualizarContadoresEstoque() {
    const linhasVisiveis = todasGrades.filter(linha => linha.style.display !== 'none');
    
    let totalEstoque = 0;
    let estoqueBaixo = 0;
    
    linhasVisiveis.forEach(linha => {
        const badgeEstoque = linha.querySelector('td:nth-child(5) .badge');
        if (badgeEstoque) {
            const textoEstoque = badgeEstoque.textContent.trim();
            const estoque = parseInt(textoEstoque) || 0;
            totalEstoque += estoque;
            
            if (badgeEstoque.classList.contains('bg-danger') && estoque > 0) {
                estoqueBaixo++;
            }
        }
    });
    
    const totalEstoqueElement = document.getElementById('total-estoque');
    if (totalEstoqueElement) {
        totalEstoqueElement.textContent = totalEstoque;
    }
    
    const estoqueBaixoElement = document.querySelector('.text-warning');
    if (estoqueBaixoElement) {
        estoqueBaixoElement.textContent = estoqueBaixo;
    }
}

// LIMPAR BUSCA
function limparBusca() {
    const campoBusca = document.getElementById('buscaEstoque');
    const btnLimpar = document.getElementById('limpar-busca');
    const inputBuscaOriginal = document.getElementById('inputBuscaOriginal');
    
    campoBusca.value = '';
    ultimoCodigoLido = '';
    filtrarTabelaEstoque('');
    
    btnLimpar.style.display = 'none';
    campoBusca.focus();
    
    if (inputBuscaOriginal) {
        inputBuscaOriginal.value = '';
    }
}
</script>
{% endblock %}