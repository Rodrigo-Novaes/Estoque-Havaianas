{% extends "layout/base.html" %}

{% block title %}Relat√≥rio de Vendas - Havaianas{% endblock %}

{% block page_title %}
<i class="bi bi-receipt me-2"></i>Relat√≥rio de Vendas
{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <button type="button" class="btn btn-sm btn-outline-primary" onclick="window.print()">
        <i class="bi bi-printer me-1"></i> Imprimir
    </button>
    <button type="button" class="btn btn-sm btn-outline-success" onclick="exportarParaExcel()">
        <i class="bi bi-file-excel me-1"></i> Excel
    </button>
    <a href="{{ url_for('pdv') }}" class="btn btn-sm btn-success">
        <i class="bi bi-cash-coin me-1"></i> Nova Venda
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Filtros Autom√°ticos - COM BOT√ïES LIMPAR INDIVIDUAIS -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h6 class="mb-0">
            <i class="bi bi-funnel me-2"></i>Filtros Autom√°ticos
            <small class="text-muted float-end" id="statusFiltro">Sem filtros</small>
        </h6>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label small">Data In√≠cio</label>
                <div class="input-group">
                    <input type="date" class="form-control form-control-sm filtro-auto" id="filtroDataInicio">
                    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="limparFiltroIndividual('dataInicio')" title="Limpar filtro" style="display: none;" id="limpar-dataInicio">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Data Fim</label>
                <div class="input-group">
                    <input type="date" class="form-control form-control-sm filtro-auto" id="filtroDataFim">
                    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="limparFiltroIndividual('dataFim')" title="Limpar filtro" style="display: none;" id="limpar-dataFim">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Forma de Pagamento</label>
                <div class="input-group">
                    <select class="form-select form-select-sm filtro-auto" id="filtroFormaPagamento">
                        <option value="">Todas as Formas</option>
                        <option value="DINHEIRO">Dinheiro</option>
                        <option value="CARTAO_CREDITO">Cart√£o Cr√©dito</option>
                        <option value="CARTAO_DEBITO">Cart√£o D√©bito</option>
                        <option value="PIX">PIX</option>
                        <option value="TRANSFERENCIA">Transfer√™ncia</option>
                    </select>
                    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="limparFiltroIndividual('formaPagamento')" title="Limpar filtro" style="display: none;" id="limpar-formaPagamento">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Buscar</label>
                <div class="input-group">
                    <input type="text" class="form-control form-control-sm filtro-auto" id="filtroBusca" placeholder="Cliente, vendedor ou ID...">
                    <button class="btn btn-sm btn-outline-secondary" type="button" onclick="limparFiltroIndividual('busca')" title="Limpar filtro" style="display: none;" id="limpar-busca">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estat√≠sticas Din√¢micas -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-success h-100">
            <div class="card-body text-center">
                <h6 class="text-success">Total em Vendas</h6>
                <h2 class="mb-0" id="totalVendas">{{ total_vendas|format_currency }}</h2>
                <small class="text-muted">Valor total vendido</small>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-primary h-100">
            <div class="card-body text-center">
                <h6 class="text-primary">N√∫mero de Vendas</h6>
                <h2 class="mb-0" id="numeroVendas">{{ vendas|length }}</h2>
                <small class="text-muted">Transa√ß√µes realizadas</small>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-info h-100">
            <div class="card-body text-center">
                <h6 class="text-info">Total de Itens</h6>
                <h2 class="mb-0" id="totalItens">{{ total_itens }}</h2>
                <small class="text-muted">Unidades vendidas</small>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-warning h-100">
            <div class="card-body text-center">
                <h6 class="text-warning">Ticket M√©dio</h6>
                <h2 class="mb-0" id="ticketMedio">
                    {% if vendas|length > 0 %}
                        {{ (total_vendas/vendas|length)|format_currency }}
                    {% else %}
                        R$ 0,00
                    {% endif %}
                </h2>
                <small class="text-muted">Por venda</small>
            </div>
        </div>
    </div>
</div>

<!-- Formas de Pagamento Din√¢micas -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white border-bottom">
                <h6 class="mb-0">
                    <i class="bi bi-credit-card me-2"></i>
                    Formas de Pagamento
                    <small class="text-muted float-end" id="contadorFormas">Resumo</small>
                </h6>
            </div>
            <div class="card-body" id="containerFormasPagamento">
                <div class="row">
                    {% for forma in formas_pagamento %}
                    <div class="col-md-3 col-6 mb-3">
                        <div class="border rounded p-3 text-center">
                            <h6 class="mb-1">{{ forma.forma_pagamento or 'N√£o informado' }}</h6>
                            <div class="text-primary fw-bold">{{ forma.quantidade }} vendas</div>
                            <small class="text-success">{{ forma.total|format_currency if forma.total else "R$ 0,00" }}</small>
                        </div>
                    </div>
                    {% else %}
                    <div class="col-12 text-center py-3">
                        <p class="text-muted mb-0">Nenhuma venda encontrada</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabela de Vendas -->
<div class="card">
    <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
        <div>
            <h5 class="mb-0">
                <i class="bi bi-list-check me-2"></i>
                Hist√≥rico de Vendas
            </h5>
            <small class="text-muted">Filtros aplicados automaticamente</small>
        </div>
        <span class="badge bg-primary" id="badgeContador">{{ vendas|length }} vendas</span>
    </div>
    
    <div class="card-body p-0">
        {% if vendas %}
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="tabelaVendas">
                <thead class="table-light">
                    <tr>
                        <th width="10%">ID</th>
                        <th width="20%">Data/Hora</th>
                        <th width="25%">Cliente</th>
                        <th width="15%">Pagamento</th>
                        <th width="15%">Itens</th>
                        <th width="15%">Total</th>
                        <th width="10%">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela">
                    {% for venda in vendas %}
                    <tr data-id="{{ venda.id }}"
                        data-data="{{ venda.data.strftime('%Y-%m-%d') }}"
                        data-pagamento="{{ venda.forma_pagamento or '' }}"
                        data-cliente="{{ (venda.cliente or '')|lower }}"
                        data-vendedor="{{ (venda.vendedor or '')|lower }}"
                        data-total="{{ venda.total }}"
                        data-itens="{{ venda.itens|sum(attribute='quantidade') }}"
                        data-id-formatado="{{ "%03d"|format(venda.id) }}">
                        <td>
                            <span class="badge bg-dark">#{{ "%03d"|format(venda.id) }}</span>
                        </td>
                        <td>
                            <small class="text-muted">{{ venda.data.strftime('%d/%m/%Y') }}</small><br>
                            <small>{{ venda.data.strftime('%H:%M') }}</small>
                        </td>
                        <td>
                            <div class="fw-medium">{{ venda.cliente or 'N√£o informado' }}</div>
                            <small class="text-muted">{{ venda.vendedor or 'Sistema' }}</small>
                        </td>
                        <td>
                            <span class="badge pagamento-badge" data-pagamento="{{ venda.forma_pagamento or '' }}">
                                {% if venda.forma_pagamento == 'DINHEIRO' %}Dinheiro
                                {% elif venda.forma_pagamento == 'CARTAO_CREDITO' %}Cart√£o Cr√©dito
                                {% elif venda.forma_pagamento == 'CARTAO_DEBITO' %}Cart√£o D√©bito
                                {% elif venda.forma_pagamento == 'PIX' %}PIX
                                {% elif venda.forma_pagamento == 'TRANSFERENCIA' %}Transfer√™ncia
                                {% else %}{{ venda.forma_pagamento or 'N/A' }}
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="fw-bold">{{ venda.itens|sum(attribute='quantidade') }}</span>
                            <small class="text-muted d-block">itens</small>
                        </td>
                        <td>
                            <span class="fw-bold text-success">{{ venda.total|format_currency }}</span>
                            {% if venda.desconto > 0 %}
                            <small class="text-danger d-block">-{{ venda.desconto|format_currency }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <!-- Bot√µes corrigidos com espa√ßamento igual ao fornecedor -->
                            <div class="d-flex gap-1">
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="verDetalhesVenda({{ venda.id }})" title="Ver detalhes">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="reimprimirVenda({{ venda.id }})" title="Reimprimir">
                                    <i class="bi bi-printer"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmarExclusaoVenda({{ venda.id }})" title="Excluir venda">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-cart-x text-muted fa-3x mb-3"></i>
            <h5 class="text-muted">Nenhuma venda encontrada</h5>
            <p class="text-muted">Tente ajustar os filtros ou realize uma venda.</p>
            <a href="{{ url_for('pdv') }}" class="btn btn-success">
                <i class="bi bi-cash-coin me-1"></i> Nova Venda
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para Detalhes da Venda -->
<div class="modal fade" id="modalDetalhesVenda" tabindex="-1" aria-labelledby="modalDetalhesVendaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Conte√∫do ser√° preenchido via JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}

<!-- Inclua SweetAlert2 se n√£o estiver no base.html -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script src="{{ url_for('static', filename='js/comprovante/comprovante.js') }}"></script>

<script>
// Primeiro, verifique se SweetAlert2 est√° carregado
if (typeof Swal === 'undefined') {
    console.error('SweetAlert2 n√£o est√° carregado. Carregando agora...');
    // Carrega dinamicamente se n√£o estiver
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
    document.head.appendChild(script);
    
    script.onload = function() {
        console.log('SweetAlert2 carregado com sucesso');
        inicializarFuncoes();
    };
} else {
    console.log('SweetAlert2 j√° est√° carregado');
    $(document).ready(function() {
        inicializarFuncoes();
    });
}

function inicializarFuncoes() {
    // Inicializar DataTable
    $('#tabelaVendas').DataTable({
        language: {
            url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json"
        },
        pageLength: 25,
        order: [[0, 'desc']],
        responsive: true,
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>tip'
    });
    
    // Aplicar cores aos badges de pagamento
    $('.pagamento-badge').each(function() {
        var pagamento = $(this).data('pagamento');
        $(this).removeClass().addClass('badge pagamento-badge');
        
        if (pagamento === 'DINHEIRO') {
            $(this).addClass('bg-success');
        } else if (pagamento === 'CARTAO_CREDITO') {
            $(this).addClass('bg-primary');
        } else if (pagamento === 'CARTAO_DEBITO') {
            $(this).addClass('bg-info');
        } else if (pagamento === 'PIX') {
            $(this).addClass('bg-warning text-dark');
        } else if (pagamento === 'TRANSFERENCIA') {
            $(this).addClass('bg-dark');
        } else {
            $(this).addClass('bg-secondary');
        }
    });
    
    // Configurar filtros autom√°ticos
    var timeoutBusca;
    $('#filtroBusca').on('keyup', function() {
        clearTimeout(timeoutBusca);
        timeoutBusca = setTimeout(aplicarFiltros, 500);
        verificarBotaoLimpar('busca', $(this).val());
    });
    
    $('#filtroDataInicio').on('change', function() {
        aplicarFiltros();
        verificarBotaoLimpar('dataInicio', $(this).val());
    });
    
    $('#filtroDataFim').on('change', function() {
        aplicarFiltros();
        verificarBotaoLimpar('dataFim', $(this).val());
    });
    
    $('#filtroFormaPagamento').on('change', function() {
        aplicarFiltros();
        verificarBotaoLimpar('formaPagamento', $(this).val());
    });
    
    // Verificar estado inicial dos bot√µes
    verificarBotaoLimpar('dataInicio', $('#filtroDataInicio').val());
    verificarBotaoLimpar('dataFim', $('#filtroDataFim').val());
    verificarBotaoLimpar('formaPagamento', $('#filtroFormaPagamento').val());
    verificarBotaoLimpar('busca', $('#filtroBusca').val());
    
    // Evento para bot√£o reimprimir no modal
    $(document).on('click', '.btn-reimprimir', function() {
        var vendaId = $(this).data('venda-id');
        reimprimirVenda(vendaId);
    });
}

// Fun√ß√£o para verificar se deve mostrar bot√£o limpar
function verificarBotaoLimpar(campoId, valor) {
    const btnLimpar = $(`#limpar-${campoId}`);
    if (btnLimpar.length) {
        if (valor && valor !== '') {
            btnLimpar.show();
        } else {
            btnLimpar.hide();
        }
    }
}

// Fun√ß√£o para limpar filtro individual
function limparFiltroIndividual(campoId) {
    if (campoId === 'dataInicio') {
        $('#filtroDataInicio').val('').trigger('change');
        $('#limpar-dataInicio').hide();
    } else if (campoId === 'dataFim') {
        $('#filtroDataFim').val('').trigger('change');
        $('#limpar-dataFim').hide();
    } else if (campoId === 'formaPagamento') {
        $('#filtroFormaPagamento').val('').trigger('change');
        $('#limpar-formaPagamento').hide();
    } else if (campoId === 'busca') {
        $('#filtroBusca').val('').trigger('keyup');
        $('#limpar-busca').hide();
    }
}

// ============ FUN√á√ïES PRINCIPAIS ============

function formatarIdComZeros(id) {
    return id.toString().padStart(3, '0');
}

function formatarMoeda(valor) {
    var numero = typeof valor === 'string' ? parseFloat(valor) : valor;
    if (isNaN(numero)) {
        return 'R$ 0,00';
    }
    return numero.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// ============ FILTROS ============

function aplicarFiltros() {
    var dataInicio = $('#filtroDataInicio').val();
    var dataFim = $('#filtroDataFim').val();
    var formaPagamento = $('#filtroFormaPagamento').val();
    var busca = $('#filtroBusca').val().toLowerCase().trim();
    
    var totalVendasFiltrado = 0;
    var totalItensFiltrado = 0;
    var contadorVendas = 0;
    
    $('#corpoTabela tr').each(function() {
        var $linha = $(this);
        var dataVenda = $linha.data('data');
        var pagamentoVenda = $linha.data('pagamento');
        var clienteVenda = $linha.data('cliente') || '';
        var vendedorVenda = $linha.data('vendedor') || '';
        var idVenda = $linha.data('id');
        var idFormatadoVenda = $linha.data('id-formatado') || formatarIdComZeros(idVenda);
        var totalVenda = parseFloat($linha.data('total')) || 0;
        var itensVenda = parseInt($linha.data('itens')) || 0;
        
        var mostrar = true;
        
        // Filtro por data
        if (dataInicio && dataVenda && dataVenda < dataInicio) {
            mostrar = false;
        }
        if (dataFim && dataVenda && dataVenda > dataFim) {
            mostrar = false;
        }
        
        // Filtro por forma de pagamento
        if (formaPagamento && pagamentoVenda !== formaPagamento) {
            mostrar = false;
        }
        
        // Filtro por busca
        if (busca) {
            var buscaCliente = clienteVenda.includes(busca);
            var buscaVendedor = vendedorVenda.includes(busca);
            var buscaId = idVenda.toString().includes(busca) || idFormatadoVenda.includes(busca);
            
            if (!buscaCliente && !buscaVendedor && !buscaId) {
                mostrar = false;
            }
        }
        
        if (mostrar) {
            $linha.show();
            contadorVendas++;
            totalVendasFiltrado += totalVenda;
            totalItensFiltrado += itensVenda;
        } else {
            $linha.hide();
        }
    });
    
    // Atualizar interface
    $('#badgeContador').text(contadorVendas + ' vendas');
    $('#totalVendas').text(formatarMoeda(totalVendasFiltrado));
    $('#numeroVendas').text(contadorVendas);
    $('#totalItens').text(totalItensFiltrado);
    
    var ticketMedio = contadorVendas > 0 ? totalVendasFiltrado / contadorVendas : 0;
    $('#ticketMedio').text(formatarMoeda(ticketMedio));
    
    atualizarStatusFiltro();
}

function atualizarStatusFiltro() {
    var dataInicio = $('#filtroDataInicio').val();
    var dataFim = $('#filtroDataFim').val();
    var formaPagamento = $('#filtroFormaPagamento').val();
    var busca = $('#filtroBusca').val();
    
    var filtrosAtivos = [];
    
    if (dataInicio || dataFim) {
        if (dataInicio && dataFim) {
            filtrosAtivos.push('Per√≠odo: ' + formatarDataBR(dataInicio) + ' a ' + formatarDataBR(dataFim));
        } else if (dataInicio) {
            filtrosAtivos.push('A partir de: ' + formatarDataBR(dataInicio));
        } else if (dataFim) {
            filtrosAtivos.push('At√©: ' + formatarDataBR(dataFim));
        }
    }
    
    if (formaPagamento) {
        filtrosAtivos.push('Pagamento: ' + $('#filtroFormaPagamento option:selected').text());
    }
    
    if (busca) {
        filtrosAtivos.push('Busca: "' + busca + '"');
    }
    
    if (filtrosAtivos.length > 0) {
        $('#statusFiltro').text(filtrosAtivos.join(' ‚Ä¢ '));
        $('.card-header.bg-light').addClass('border-primary');
    } else {
        $('#statusFiltro').text('Sem filtros');
        $('.card-header.bg-light').removeClass('border-primary');
    }
}

function formatarDataBR(dataString) {
    if (!dataString) return '';
    var partes = dataString.split('-');
    return partes[2] + '/' + partes[1] + '/' + partes[0];
}

// ============ EXCLUIR VENDA - USANDO CONFIRM() IGUAL AO FORNECEDOR ============

function confirmarExclusaoVenda(vendaId) {
    console.log('Confirmando exclus√£o da venda #' + vendaId);
    
    const idFormatado = formatarIdComZeros(vendaId);
    
    // Usa confirm() igual √†s outras p√°ginas do sistema
    if (confirm(`Tem certeza que deseja excluir a venda #${idFormatado}?`)) {
        excluirVenda(vendaId);
    }
}

function excluirVenda(vendaId) {
    console.log("üîÑ Iniciando exclus√£o da venda #" + vendaId);
    
    const idFormatado = formatarIdComZeros(vendaId);
    
    // Mostra feedback visual na linha
    const linha = $(`tr[data-id="${vendaId}"]`);
    if (linha.length) {
        linha.css('opacity', '0.5');
    }

    // Faz a requisi√ß√£o DELETE para a API
    fetch(`/api/pdv/venda/${vendaId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // REDIRECIONAR com mensagem de sucesso
            window.location.href = `/relatorios/vendas?mensagem=excluida&id=${vendaId}`;
        } else {
            alert(`‚ùå Erro: ${data.message || 'N√£o foi poss√≠vel excluir a venda.'}`);
        }
    })
    .catch(error => {
        alert('‚ùå Erro ao conectar com o servidor.');
    })
    .finally(() => {
        if (linha.length) {
            linha.css('opacity', '1');
        }
    });
}

// Fun√ß√£o auxiliar para obter token CSRF
function getCsrfToken() {
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag) {
        return metaTag.getAttribute('content');
    }
    
    const inputTag = document.querySelector('input[name="csrf_token"]');
    if (inputTag) {
        return inputTag.value;
    }
    
    return '';
}

// ============ DETALHES DA VENDA ============

function verDetalhesVenda(vendaId) {
    var modalContent = document.querySelector('#modalDetalhesVenda .modal-content');
    modalContent.innerHTML = `
        <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
                <i class="bi bi-hourglass-split me-2"></i>
                Carregando Venda #${formatarIdComZeros(vendaId)}
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <div class="text-center py-5">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                <p class="text-muted">Buscando detalhes da venda...</p>
            </div>
        </div>
    `;
    
    $('#modalDetalhesVenda').modal('show');
    
    fetch('/api/pdv/venda/' + vendaId + '/comprovante')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.comprovante) {
                exibirDetalhesVenda(data.comprovante);
            } else {
                mostrarErroNoModal('N√£o foi poss√≠vel carregar os detalhes');
            }
        })
        .catch(error => {
            mostrarErroNoModal('Erro: ' + error.message);
        });
}

function exibirDetalhesVenda(venda) {
    var dataVenda = new Date(venda.data_criacao);
    var dataFormatada = dataVenda.toLocaleDateString('pt-BR');
    var horaFormatada = dataVenda.toLocaleTimeString('pt-BR');
    
    var itensHTML = '';
    var totalItens = 0;
    
    if (venda.itens && venda.itens.length > 0) {
        venda.itens.forEach(item => {
            totalItens += item.quantidade;
            var subtotal = item.preco * item.quantidade;
            
            itensHTML += `
                <tr>
                    <td><span class="badge bg-light text-dark border">${item.sku || 'N/A'}</span></td>
                    <td>
                        <div class="fw-medium">${item.descricao || 'Produto'}</div>
                        ${item.cor || item.tamanho ? `
                        <div class="mt-1">
                            ${item.cor ? '<span class="badge bg-light text-dark border me-1"><i class="bi bi-palette"></i> ' + item.cor + '</span>' : ''}
                            ${item.tamanho ? '<span class="badge bg-light text-dark border"><i class="bi bi-rulers"></i> ' + item.tamanho + '</span>' : ''}
                        </div>
                        ` : ''}
                    </td>
                    <td class="text-center"><span class="badge bg-primary rounded-pill">${item.quantidade}</span></td>
                    <td class="text-end fw-semibold">${formatarMoeda(item.preco)}</td>
                    <td class="text-end fw-bold text-success">${formatarMoeda(subtotal)}</td>
                </tr>
            `;
        });
    }
    
    // Verifica se tem CPF ou CNPJ
    const cpfCnpj = venda.cliente_cpf || venda.cliente_cnpj || venda.cpf || '';
    const cpfHTML = cpfCnpj ? `
        <div class="mb-2">
            <small class="text-muted d-block">CPF/CNPJ</small>
            <div class="fw-medium">${cpfCnpj}</div>
        </div>
    ` : '';
    
    var modalHTML = `
        <div class="modal-header bg-primary text-white">
            <div class="d-flex align-items-center w-100">
                <div class="me-3"><i class="bi bi-receipt display-6"></i></div>
                <div>
                    <h5 class="modal-title mb-1">Venda #${venda.venda_id_formatado || formatarIdComZeros(venda.venda_id)}</h5>
                    <small class="opacity-75">${dataFormatada} √†s ${horaFormatada}</small>
                </div>
                <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal"></button>
            </div>
        </div>
        <div class="modal-body p-0">
            <div class="p-4 border-bottom">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card h-100 border-0 bg-light">
                            <div class="card-body">
                                <h6 class="card-title text-muted mb-3"><i class="bi bi-person-circle me-2"></i>Informa√ß√µes</h6>
                                <div class="mb-2">
                                    <small class="text-muted d-block">Cliente</small>
                                    <div class="fw-medium">${venda.cliente_nome || venda.cliente || 'N√£o informado'}</div>
                                </div>
                                ${cpfHTML}
                                <div class="mb-2">
                                    <small class="text-muted d-block">Vendedor</small>
                                    <div class="fw-medium">${venda.vendedor || 'Sistema'}</div>
                                </div>
                                <div>
                                    <small class="text-muted d-block">Forma de Pagamento</small>
                                    <span class="badge pagamento-badge fs-6 px-3 py-2">${formatarFormaPagamentoTexto(venda.forma_pagamento) || 'N√£o informado'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card h-100 border-0 bg-light">
                            <div class="card-body">
                                <h6 class="card-title text-muted mb-3"><i class="bi bi-calculator me-2"></i>Resumo Financeiro</h6>
                                <div class="mb-2 d-flex justify-content-between">
                                    <span>Subtotal:</span>
                                    <span class="fw-medium">${formatarMoeda(venda.subtotal || 0)}</span>
                                </div>
                                ${venda.desconto_valor > 0 ? `
                                <div class="mb-2 d-flex justify-content-between text-danger">
                                    <span>Desconto (${venda.desconto_percentual || 0}%):</span>
                                    <span class="fw-medium">-${formatarMoeda(venda.desconto_valor)}</span>
                                </div>
                                ` : ''}
                                <hr>
                                <div class="d-flex justify-content-between fs-5 fw-bold text-success">
                                    <span>TOTAL:</span>
                                    <span>${formatarMoeda(venda.total || 0)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-muted mb-0">
                        <i class="bi bi-box-seam me-2"></i>Itens Vendidos
                        <span class="badge bg-primary rounded-pill ms-2">${totalItens} unidades</span>
                    </h6>
                </div>
                
                <div class="table-responsive rounded border">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="15%" class="ps-3">SKU</th>
                                <th width="40%">Descri√ß√£o</th>
                                <th width="15%" class="text-center">Quantidade</th>
                                <th width="15%" class="text-end">Pre√ßo Unit.</th>
                                <th width="15%" class="text-end pe-3">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>${itensHTML}</tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                <i class="bi bi-x-circle me-1"></i> Fechar
            </button>
            <button type="button" class="btn btn-primary btn-reimprimir" data-venda-id="${venda.venda_id}">
                <i class="bi bi-printer me-1"></i> Reimprimir Venda
            </button>
        </div>
    `;
    
    var modalContent = document.querySelector('#modalDetalhesVenda .modal-content');
    modalContent.innerHTML = modalHTML;
    
    // Colorir o badge de pagamento
    const badge = modalContent.querySelector('.pagamento-badge');
    if (badge) {
        const forma = venda.forma_pagamento;
        badge.classList.remove('bg-success', 'bg-primary', 'bg-info', 'bg-warning', 'bg-dark');
        
        if (forma === 'DINHEIRO') {
            badge.classList.add('bg-success');
        } else if (forma === 'CARTAO_CREDITO') {
            badge.classList.add('bg-primary');
        } else if (forma === 'CARTAO_DEBITO') {
            badge.classList.add('bg-info');
        } else if (forma === 'PIX') {
            badge.classList.add('bg-warning', 'text-dark');
        } else if (forma === 'TRANSFERENCIA') {
            badge.classList.add('bg-dark');
        } else {
            badge.classList.add('bg-secondary');
        }
    }
}

function formatarFormaPagamentoTexto(forma) {
    const formatos = {
        'DINHEIRO': 'Dinheiro',
        'CARTAO_CREDITO': 'Cart√£o Cr√©dito',
        'CARTAO_DEBITO': 'Cart√£o D√©bito',
        'PIX': 'PIX',
        'TRANSFERENCIA': 'Transfer√™ncia'
    };
    return formatos[forma] || forma;
}

function mostrarErroNoModal(mensagem) {
    var modalContent = document.querySelector('#modalDetalhesVenda .modal-content');
    modalContent.innerHTML = `
        <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Erro ao Carregar Venda
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <div class="text-center py-4">
                <div class="mb-3"><i class="bi bi-x-circle text-danger display-4"></i></div>
                <h5 class="text-danger mb-3">Ocorreu um erro</h5>
                <div class="alert alert-danger text-start">
                    <i class="bi bi-info-circle me-2"></i>
                    ${mensagem}
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                <i class="bi bi-x-circle me-1"></i> Fechar
            </button>
        </div>
    `;
}

// ============ REIMPRESS√ÉO CORRIGIDA ============
function reimprimirVenda(vendaId) {
    console.log("üîÑ Reimprimindo venda #" + vendaId);
    
    // Mostra feedback visual
    Swal.fire({
        title: 'Gerando comprovante...',
        text: 'Aguarde',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    fetch('/api/pdv/venda/' + vendaId + '/comprovante')
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na resposta do servidor');
            }
            return response.json();
        })
        .then(data => {
            Swal.close();
            
            if (data.success && data.comprovante) {
                const venda = data.comprovante;
                
                // Formata a data corretamente
                let dataFormatada = '';
                try {
                    const dataVenda = new Date(venda.data_criacao);
                    dataFormatada = dataVenda.toLocaleDateString('pt-BR') + ' ' + 
                                   dataVenda.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                } catch (e) {
                    dataFormatada = new Date().toLocaleDateString('pt-BR');
                }
                
                // Buscar configura√ß√µes da empresa (pode vir do backend ou usar dados fixos)
                const empresa = venda.empresa || {
                    razao_social: 'Havaianas Store',
                    nome_fantasia: 'Havaianas',
                    cnpj_formatado: '',
                    endereco: '',
                    contato: '',
                    rodape: 'Obrigado pela prefer√™ncia!'
                };
                
                // Preparar dados da venda
                const dadosVenda = {
                    venda_id: venda.venda_id || venda.id,
                    venda_id_formatado: venda.venda_id_formatado || ('000' + (venda.venda_id || venda.id)).slice(-3),
                    data: dataFormatada,
                    cliente: venda.cliente_nome || venda.cliente || 'CONSUMIDOR',
                    cpf: venda.cliente_cpf || venda.cliente_cnpj || '',
                    vendedor: venda.vendedor || 'Sistema',
                    itens: venda.itens || [],
                    subtotal: venda.subtotal || 0,
                    total: venda.total || 0,
                    desconto_percentual: venda.desconto_percentual || 0,
                    desconto_valor: venda.desconto_valor || 0,
                    forma_pagamento: venda.forma_pagamento || '',
                    
                    // Dados da empresa
                    empresa: empresa
                };
                
                // ABRE JANELA VIS√çVEL
                const janela = window.open('', 'Comprovante', 
                    'width=900,height=600,top=100,left=100,scrollbars=yes,resizable=yes'
                );
                
                if (!janela) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Pop-up bloqueado',
                        text: 'Permita popups para ver o comprovante!'
                    });
                    return;
                }
                
                // Verifica se a fun√ß√£o imprimirComprovante existe
                if (typeof imprimirComprovante === 'function') {
                    imprimirComprovante(janela, dadosVenda);
                } else {
                    // Fallback: gerar HTML manualmente
                    gerarComprovanteManual(janela, dadosVenda);
                }
                
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'Comprovante gerado!',
                    showConfirmButton: false,
                    timer: 2000
                });
                
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'N√£o foi poss√≠vel gerar o comprovante.'
                });
            }
        })
        .catch(err => {
            Swal.close();
            console.error('Erro:', err);
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: 'Erro ao conectar com o servidor.'
            });
        });
}

// Fun√ß√£o de fallback caso comprovante.js n√£o esteja carregado
function gerarComprovanteManual(janela, venda) {
    const html = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Comprovante de Venda #${venda.venda_id_formatado}</title>
        <meta charset="UTF-8">
        <style>
            body { font-family: 'Courier New', monospace; margin: 20px; font-size: 12px; }
            h1 { text-align: center; font-size: 16px; }
            h2 { text-align: center; font-size: 14px; }
            hr { border-top: 1px dashed #000; }
            table { width: 100%; border-collapse: collapse; }
            th, td { padding: 5px 0; }
            .total { font-weight: bold; font-size: 14px; }
            .center { text-align: center; }
            .right { text-align: right; }
            @media print { body { margin: 0; } }
        </style>
    </head>
    <body>
        <h1>${venda.empresa.nome_fantasia || 'Havaianas Store'}</h1>
        <div class="center">${venda.empresa.razao_social || ''}</div>
        ${venda.empresa.cnpj_formatado ? '<div class="center">' + venda.empresa.cnpj_formatado + '</div>' : ''}
        ${venda.empresa.endereco ? '<div class="center">' + venda.empresa.endereco + '</div>' : ''}
        <hr>
        <div class="center">COMPROVANTE DE VENDA</div>
        <div class="center">#${venda.venda_id_formatado}</div>
        <div class="center">${venda.data}</div>
        <hr>
        <div>Cliente: ${venda.cliente}</div>
        ${venda.cpf ? '<div>CPF/CNPJ: ' + venda.cpf + '</div>' : ''}
        <div>Vendedor: ${venda.vendedor}</div>
        <hr>
        <table>
            <tr>
                <th>Item</th>
                <th class="center">Qtd</th>
                <th class="right">Pre√ßo</th>
                <th class="right">Total</th>
            </tr>
            ${venda.itens.map((item, idx) => `
            <tr>
                <td>${idx+1}. ${item.descricao || item.sku || 'Produto'}</td>
                <td class="center">${item.quantidade}</td>
                <td class="right">R$ ${item.preco.toFixed(2).replace('.', ',')}</td>
                <td class="right">R$ ${(item.quantidade * item.preco).toFixed(2).replace('.', ',')}</td>
            </tr>
            `).join('')}
        </table>
        <hr>
        <div class="right">Subtotal: R$ ${venda.subtotal.toFixed(2).replace('.', ',')}</div>
        ${venda.desconto_valor > 0 ? '<div class="right">Desconto: -R$ ' + venda.desconto_valor.toFixed(2).replace('.', ',') + '</div>' : ''}
        <div class="right total">TOTAL: R$ ${venda.total.toFixed(2).replace('.', ',')}</div>
        <hr>
        <div>Forma: ${venda.forma_pagamento.replace('_', ' ')}</div>
        <hr>
        <div class="center">${venda.empresa.rodape || 'Obrigado pela prefer√™ncia!'}</div>
    </body>
    </html>
    `;
    
    janela.document.write(html);
    janela.document.close();
    janela.focus();
    janela.print();
}
// ============ EXPORTAR EXCEL ============

function exportarParaExcel() {
    var contador = $('#badgeContador').text();
    if (contador.includes('0 vendas')) {
        Swal.fire({
            icon: 'warning',
            title: 'Nenhum dado para exportar',
            text: 'N√£o h√° vendas com os filtros atuais para exportar.'
        });
        return;
    }
    
    $('#tabelaVendas').DataTable().button('.buttons-excel').trigger();
}

</script>

<style>
.filtro-auto.is-valid {
    border-color: #198754;
    background-color: rgba(25, 135, 84, 0.05);
}

.card-header.bg-light.border-primary {
    border-left: 4px solid #0d6efd !important;
}

#corpoTabela tr {
    transition: all 0.3s ease;
}

#corpoTabela tr:hover {
    background-color: rgba(13, 110, 253, 0.05) !important;
}

.badge.bg-dark {
    
    letter-spacing: 1px;
    font-weight: 600;
}

/* Estilo para os bot√µes de a√ß√£o - IGUAL AO FORNECEDOR */
.d-flex.gap-1 {
    gap: 0.25rem !important;
}

.btn-outline-info {
    color: #0dcaf0;
    border-color: #0dcaf0;
}
.btn-outline-info:hover {
    color: #000;
    background-color: #0dcaf0;
    border-color: #0dcaf0;
}

.btn-outline-primary {
    color: #0d6efd;
    border-color: #0d6efd;
}
.btn-outline-primary:hover {
    color: #fff;
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.btn-outline-danger {
    color: #dc3545;
    border-color: #dc3545;
}
.btn-outline-danger:hover {
    color: #fff;
    background-color: #dc3545;
    border-color: #dc3545;
}

/* Tamanho dos bot√µes */
.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    border-radius: 0.2rem;
}

.btn-outline-danger:hover {
    background-color: #dc3545;
    color: white;
}

/* Efeito de exclus√£o na linha */
@keyframes fadeOutDelete {
    from { opacity: 1; background-color: #fff; }
    to { opacity: 0; background-color: #ffe6e6; }
}

tr.deleting {
    animation: fadeOutDelete 0.5s ease-out;
}

@media (max-width: 768px) {
    .col-md-3 {
        margin-bottom: 10px;
    }
    #statusFiltro {
        display: none;
    }
}
</style>
{% endblock %}