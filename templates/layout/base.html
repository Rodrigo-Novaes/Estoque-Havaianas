<!doctype html>
<html lang="pt-br" data-bs-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Estoque Havaianas{% endblock %}</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" />
    
    <!-- CSS DO SISTEMA (agora em arquivo separado) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style_base.css') }}">

    {% block extra_css %}{% endblock %}
  </head>
  
  <body>
    <!-- SCRIPT ANTI-TREMEDEIRA - EXECUTA ANTES DE TUDO -->
    <script>
      (function() {
        // Aplicar classes corretas ANTES da página renderizar
        var sidebar = document.getElementById('sidebar');
        var btn = document.getElementById('btnToggle');
        var mainContent = document.getElementById('mainContent');
        
        if (sidebar && btn && mainContent) {
          var isMobile = window.innerWidth <= 991;
          
          // Remover qualquer classe que possa causar flicker
          sidebar.classList.remove('collapsed', 'mobile-show');
          mainContent.classList.remove('expanded');
          btn.classList.remove('collapsed', 'mobile-show');
          
          // Configurar estado inicial
          if (isMobile) {
            btn.innerHTML = '<i class="bi bi-list"></i>';
            btn.style.left = '10px';
          } else {
            btn.innerHTML = '<i class="bi bi-chevron-left"></i>';
            btn.style.left = 'calc(220px - 15px)';
          }
          
          // Garantir que a navbar tem altura fixa
          var navbar = document.querySelector('.navbar-fixed');
          if (navbar) {
            navbar.style.height = '56px';
          }
        }
      })();
    </script>

    <!-- Navbar -->
    <nav class="navbar navbar-expand navbar-dark navbar-fixed" style="background: linear-gradient(135deg, #0066cc, #00cc66)">
      <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('dashboard') }}">
          {% if empresa and empresa.logo %}
          <img src="{{ url_for('uploaded_logo', filename=empresa.logo) }}" alt="{{ empresa.nome_fantasia or 'Havaianas' }}" style="height: 40px; width: auto; margin-right: 10px" />
          {% else %}
          <i class="bi bi-shop me-2"></i>
          {% endif %}
          <strong style="font-family: '{{ empresa.fonte_navbar_familia or 'Segoe UI' }}'; font-size: {{ empresa.fonte_navbar_tamanho or 18 }}px; color: {{ empresa.fonte_navbar_cor or '#ffffff' }};">
            {{ empresa.nome_fantasia or 'HAVAIANAS STORE' }}
          </strong>
        </a>

        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('pdv') }}">
              <i class="bi bi-cash-coin me-1"></i>
              <span>PDV</span>
            </a>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
              <div class="user-avatar-circle me-1">
                {{ session.get('usuario_nome', 'A')[:1]|upper }}
              </div>
              <span class="d-none d-md-inline">{{ session.get('usuario_username', 'Admin') }}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <div class="dropdown-header d-flex align-items-center">
                  <div class="user-avatar-large">
                    {{ session.get('usuario_nome', 'A')[:1]|upper }}
                  </div>
                  <div>
                    <div class="user-name">{{ session.get('usuario_nome', 'Administrador') }}</div>
                    {% if session.get('usuario_email') %}
                    <div class="logged-as">LOGADO COMO</div>
                    <div class="user-email">{{ session.get('usuario_email') }}</div>
                    {% endif %}
                    <div class="user-role-small">
                      {% if session.get('usuario_admin') %} Administrador {% else %} Operador {% endif %}
                    </div>
                  </div>
                </div>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li><a class="dropdown-item" href="{{ url_for('perfil') }}"><i class="bi bi-person me-2"></i> Meu Perfil</a></li>
              <li><hr class="dropdown-divider" /></li>
              {% if session.get('usuario_admin') %}
              <li><a class="dropdown-item" href="{{ url_for('config_index') }}"><i class="bi bi-gear me-2"></i> Configurações</a></li>
              <li><hr class="dropdown-divider" /></li>
              {% endif %}
              {% if session.get('usuario_admin') or session.get('backup_visualizar') %}
              <li><a class="dropdown-item" href="{{ url_for('pagina_backup') }}"><i class="bi bi-database me-2"></i> Backup</a></li>
              {% endif %}
              <li><hr class="dropdown-divider" /></li>
              <li><a class="dropdown-item text-danger" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right me-2"></i> Sair</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Botão toggle -->
    <button id="btnToggle" class="btn" type="button">
      <i class="bi bi-chevron-left"></i>
    </button>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="pt-2">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}" href="{{ url_for('dashboard') }}" data-title="Dashboard">
              <i class="bi bi-speedometer2"></i> <span>Dashboard</span>
            </a>
          </li>
          
          <li class="nav-item mt-2"><small>PRODUTOS</small></li>
          <li class="nav-item">
            <a class="nav-link {% if request.endpoint == 'produtos' %}active{% endif %}" href="{{ url_for('produtos') }}" data-title="Produtos">
              <i class="bi bi-box"></i> <span>Produtos</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if request.endpoint == 'novo_produto' %}active{% endif %}" href="{{ url_for('novo_produto') }}" data-title="Novo Produto">
              <i class="bi bi-plus-circle"></i> <span>Novo Produto</span>
            </a>
          </li>
          
          <li class="nav-item mt-2"><small>ESTOQUE</small></li>
          <li class="nav-item">
            <a class="nav-link {% if request.endpoint == 'estoque' %}active{% endif %}" href="{{ url_for('estoque') }}" data-title="Consulta">
              <i class="bi bi-clipboard-data"></i> <span>Consulta</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if request.endpoint == 'entrada_estoque' %}active{% endif %}" href="{{ url_for('entrada_estoque') }}" data-title="Entrada">
              <i class="bi bi-arrow-down-circle"></i> <span>Entrada</span>
            </a>
          </li>
          
          <li class="nav-item mt-2"><small>RELATÓRIOS</small></li>
          <li class="nav-item">
            <a class="nav-link {% if request.endpoint == 'relatorio_estoque_baixo' %}active{% endif %}" href="{{ url_for('relatorio_estoque_baixo') }}" data-title="Estoque Baixo">
              <i class="bi bi-exclamation-triangle"></i> <span>Estoque Baixo</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if request.endpoint == 'relatorio_vendas' %}active{% endif %}" href="{{ url_for('relatorio_vendas') }}" data-title="Vendas">
              <i class="bi bi-receipt"></i> <span>Vendas</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if request.endpoint == 'relatorio_produtos_parados' %}active{% endif %}" href="{{ url_for('relatorio_produtos_parados') }}" data-title="Parados">
              <i class="bi bi-clock-history"></i> <span>Produtos Parados</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if request.endpoint == 'relatorio_movimentacoes' %}active{% endif %}" href="{{ url_for('relatorio_movimentacoes') }}" data-title="Movimentações">
              <i class="bi bi-arrow-left-right"></i> <span>Movimentações</span>
            </a>
          </li>
          
          <li class="nav-item mt-2"><small>CADASTROS</small></li>
          <li class="nav-item">
            <a class="nav-link {% if request.endpoint == 'listar_clientes' %}active{% endif %}" href="{{ url_for('listar_clientes') }}" data-title="Clientes">
              <i class="bi bi-people"></i> <span>Clientes</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if request.endpoint == 'lista_fornecedores' %}active{% endif %}" href="{{ url_for('lista_fornecedores') }}" data-title="Fornecedores">
              <i class="bi bi-truck"></i> <span>Fornecedores</span>
            </a>
          </li>
          
          {% if session.get('usuario_admin') %}
          <li class="nav-item">
              <a class="nav-link {% if request.endpoint == 'listar_usuarios' %}active{% endif %}" 
                href="{{ url_for('listar_usuarios') }}" data-title="Usuários">
                  <i class="bi bi-person-vcard"></i> <span>Usuários</span>
              </a>
          </li>
          {% endif %}
          
          <li class="nav-item mt-2"><small>UTILIDADES</small></li>
          <li class="nav-item">
              <a class="nav-link {% if request.endpoint == 'inventario' %}active{% endif %}" 
                href="{{ url_for('inventario') }}" data-title="Inventário">
                  <i class="bi bi-clipboard-check"></i> <span>Inventário</span>
              </a>
          </li>
          <li class="nav-item">
              <a class="nav-link {% if request.endpoint == 'sobre' %}active{% endif %}" 
                href="{{ url_for('sobre') }}" data-title="Sobre">
                  <i class="bi bi-info-circle"></i> <span>Sobre</span>
              </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Conteúdo principal -->
    <main class="main-content" id="mainContent">
      <!-- Flash messages -->
      <div id="flash-area">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              {% set flash_class = 'flash-' + ('danger' if category == 'error' else category) %}
              {% set flash_icon = 'bi-check-circle-fill' if category == 'success' else 
                                   ('bi-exclamation-triangle-fill' if category in ['danger', 'error'] else
                                   ('bi-exclamation-circle-fill' if category == 'warning' else 'bi-info-circle-fill')) %}
              <div class="flash-message {{ flash_class }}" id="flash-{{ loop.index }}">
                <div style="display: flex; align-items: center;">
                  <i class="bi {{ flash_icon }} flash-icon"></i>
                  <span>{{ message }}</span>
                </div>
                <button type="button" class="flash-close-btn" onclick="closeFlash('flash-{{ loop.index }}')">
                  <i class="bi bi-x"></i>
                </button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}
      </div>

      <!-- Título da página -->
      <div class="page-header">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center">
          <h1 class="h2">
            {% if request.endpoint == 'dashboard' %}
              <i class="bi bi-speedometer2 me-2"></i>Dashboard
            {% elif request.endpoint == 'produtos' %}
              <i class="bi bi-box me-2"></i>Produtos
            {% elif request.endpoint == 'pdv' %}
              <i class="bi bi-cash-coin me-2"></i>Ponto de Venda
            {% else %}
              {% block page_title %}{% endblock %}
            {% endif %}
          </h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            {% block page_actions %}{% endblock %}
          </div>
        </div>
      </div>

      <!-- Conteúdo -->
      <div class="content-wrapper">{% block content %}{% endblock %}</div>
    </main>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      function closeFlash(flashId) {
        const flashElement = document.getElementById(flashId);
        if (flashElement) {
          flashElement.classList.add("closing");
          setTimeout(() => flashElement.remove(), 300);
        }
      }

      // ===== FUNÇÃO GLOBAL DE MENSAGENS =====
      function mostrarMensagem(mensagem, tipo = 'success') {
          const flashArea = document.getElementById('flash-area');
          if (!flashArea) return;
          
          const msg = document.createElement('div');
          msg.className = `flash-message flash-${tipo}`;
          
          let icone = 'bi-info-circle-fill';
          if (tipo === 'success') icone = 'bi-check-circle-fill';
          if (tipo === 'danger' || tipo === 'error') icone = 'bi-exclamation-triangle-fill';
          if (tipo === 'warning') icone = 'bi-exclamation-circle-fill';
          
          const timestamp = Date.now();
          msg.id = `flash-${timestamp}`;
          
          msg.innerHTML = `
              <div style="display: flex; align-items: center;">
                  <i class="bi ${icone} flash-icon"></i>
                  <span>${mensagem}</span>
              </div>
              <button type="button" class="flash-close-btn" onclick="closeFlash('flash-${timestamp}')">
                  <i class="bi bi-x"></i>
              </button>
          `;
          
          flashArea.appendChild(msg);
          
          // Auto-remover após 3 segundos
          setTimeout(() => {
              const elemento = document.getElementById(`flash-${timestamp}`);
              if (elemento) {
                  closeFlash(`flash-${timestamp}`);
              }
          }, 3000);
      }

      function formatarNumero(num) {
        return new Intl.NumberFormat("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
      }

      function formatarData(dataStr) {
        const data = new Date(dataStr);
        return data.toLocaleDateString("pt-BR") + " " + data.toLocaleTimeString("pt-BR").substring(0, 5);
      }

      function gerenciarTitlesSidebar() {
        const sidebar = document.getElementById("sidebar");
        const isCollapsed = sidebar.classList.contains("collapsed");
        const links = sidebar.querySelectorAll(".nav-link[data-title]");
        links.forEach(link => {
          if (isCollapsed) link.setAttribute("title", link.getAttribute("data-title"));
          else link.removeAttribute("title");
        });
      }

      $(function () {
        $('[data-bs-toggle="tooltip"]').tooltip();

        $(".datatable").each(function () {
          if (!$.fn.dataTable.isDataTable(this)) {
            $(this).DataTable({
              language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json" },
              pageLength: 25,
              responsive: true,
            });
          }
        });

        document.querySelectorAll(".flash-message").forEach((message) => {
          setTimeout(() => closeFlash(message.id), 3000);
        });

        // Sidebar toggle
        const btn = document.getElementById("btnToggle");
        const sidebar = document.getElementById("sidebar");
        const mainContent = document.getElementById("mainContent");
        const overlay = document.getElementById("overlay");

        function ajustarEstadoInicial() {
          const isMobile = window.innerWidth <= 991;
          if (isMobile) {
            sidebar.classList.remove("collapsed", "mobile-show");
            mainContent.classList.remove("expanded");
            btn.classList.remove("collapsed", "mobile-show");
            overlay.classList.remove("show");
            btn.innerHTML = '<i class="bi bi-list"></i>';
          } else {
            sidebar.classList.remove("collapsed", "mobile-show");
            mainContent.classList.remove("expanded");
            btn.classList.remove("collapsed", "mobile-show");
            overlay.classList.remove("show");
            btn.innerHTML = '<i class="bi bi-chevron-left"></i>';
          }
          gerenciarTitlesSidebar();
        }

        ajustarEstadoInicial();

        btn.addEventListener("click", function () {
          const isMobile = window.innerWidth <= 991;
          if (isMobile) {
            sidebar.classList.toggle("mobile-show");
            btn.classList.toggle("mobile-show");
            overlay.classList.toggle("show");
            btn.innerHTML = sidebar.classList.contains("mobile-show") ? '<i class="bi bi-x"></i>' : '<i class="bi bi-list"></i>';
          } else {
            sidebar.classList.toggle("collapsed");
            mainContent.classList.toggle("expanded");
            btn.classList.toggle("collapsed");
            btn.innerHTML = sidebar.classList.contains("collapsed") ? '<i class="bi bi-chevron-right"></i>' : '<i class="bi bi-chevron-left"></i>';
          }
          gerenciarTitlesSidebar();
        });

        overlay.addEventListener("click", function () {
          sidebar.classList.remove("mobile-show");
          btn.classList.remove("mobile-show");
          overlay.classList.remove("show");
          btn.innerHTML = '<i class="bi bi-list"></i>';
          gerenciarTitlesSidebar();
        });

        window.addEventListener("resize", ajustarEstadoInicial);
      });
    </script>

    {% block extra_js %}{% endblock %}
  </body>
</html>